/**
 * @license almond 0.3.1 Copyright (c) 2011-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

var requirejs,require,define;!function(t){function e(t,e){return g.call(t,e)}function r(t,e){var r,o,n,a,i,l,s,c,d,p,u,m=e&&e.split("/"),f=h.map,y=f&&f["*"]||{};if(t&&"."===t.charAt(0))if(e){for(t=t.split("/"),i=t.length-1,h.nodeIdCompat&&x.test(t[i])&&(t[i]=t[i].replace(x,"")),t=m.slice(0,m.length-1).concat(t),d=0;d<t.length;d+=1)if(u=t[d],"."===u)t.splice(d,1),d-=1;else if(".."===u){if(1===d&&(".."===t[2]||".."===t[0]))break;d>0&&(t.splice(d-1,2),d-=2)}t=t.join("/")}else 0===t.indexOf("./")&&(t=t.substring(2));if((m||y)&&f){for(r=t.split("/"),d=r.length;d>0;d-=1){if(o=r.slice(0,d).join("/"),m)for(p=m.length;p>0;p-=1)if(n=f[m.slice(0,p).join("/")],n&&(n=n[o])){a=n,l=d;break}if(a)break;!s&&y&&y[o]&&(s=y[o],c=d)}!a&&s&&(a=s,l=c),a&&(r.splice(0,l,a),t=r.join("/"))}return t}function o(e,r){return function(){var o=v.call(arguments,0);return"string"!=typeof o[0]&&1===o.length&&o.push(null),d.apply(t,o.concat([e,r]))}}function n(t){return function(e){return r(e,t)}}function a(t){return function(e){m[t]=e}}function i(r){if(e(f,r)){var o=f[r];delete f[r],y[r]=!0,c.apply(t,o)}if(!e(m,r)&&!e(y,r))throw new Error("No "+r);return m[r]}function l(t){var e,r=t?t.indexOf("!"):-1;return r>-1&&(e=t.substring(0,r),t=t.substring(r+1,t.length)),[e,t]}function s(t){return function(){return h&&h.config&&h.config[t]||{}}}var c,d,p,u,m={},f={},h={},y={},g=Object.prototype.hasOwnProperty,v=[].slice,x=/\.js$/;p=function(t,e){var o,a=l(t),s=a[0];return t=a[1],s&&(s=r(s,e),o=i(s)),s?t=o&&o.normalize?o.normalize(t,n(e)):r(t,e):(t=r(t,e),a=l(t),s=a[0],t=a[1],s&&(o=i(s))),{f:s?s+"!"+t:t,n:t,pr:s,p:o}},u={require:function(t){return o(t)},exports:function(t){var e=m[t];return"undefined"!=typeof e?e:m[t]={}},module:function(t){return{id:t,uri:"",exports:m[t],config:s(t)}}},c=function(r,n,l,s){var c,d,h,g,v,x,w=[],b=typeof l;if(s=s||r,"undefined"===b||"function"===b){for(n=!n.length&&l.length?["require","exports","module"]:n,v=0;v<n.length;v+=1)if(g=p(n[v],s),d=g.f,"require"===d)w[v]=u.require(r);else if("exports"===d)w[v]=u.exports(r),x=!0;else if("module"===d)c=w[v]=u.module(r);else if(e(m,d)||e(f,d)||e(y,d))w[v]=i(d);else{if(!g.p)throw new Error(r+" missing "+d);g.p.load(g.n,o(s,!0),a(d),{}),w[v]=m[d]}h=l?l.apply(m[r],w):void 0,r&&(c&&c.exports!==t&&c.exports!==m[r]?m[r]=c.exports:h===t&&x||(m[r]=h))}else r&&(m[r]=l)},requirejs=require=d=function(e,r,o,n,a){if("string"==typeof e)return u[e]?u[e](r):i(p(e,r).f);if(!e.splice){if(h=e,h.deps&&d(h.deps,h.callback),!r)return;r.splice?(e=r,r=o,o=null):e=t}return r=r||function(){},"function"==typeof o&&(o=n,n=a),n?c(t,e,r,o):setTimeout(function(){c(t,e,r,o)},4),d},d.config=function(t){return d(t)},requirejs._defined=m,define=function(t,r,o){if("string"!=typeof t)throw new Error("See almond README: incorrect module build, no module name");r.splice||(o=r,r=[]),e(m,t)||e(f,t)||(f[t]=[t,r,o])},define.amd={jQuery:!0}}(),define("../node_modules/almond/almond",function(){}),define("helpers/data",["require"],function(){"use strict";var t=function(){var t={queryHistory:[],queryQueue:[],queryRunning:[],timestamp:0,reporterAreasSelect:[],partnerAreasSelect:[],commodityCodesSelect:[],reporterAreas:{},partnerAreas:{},flowByCode:{},commodityCodes:{},countryByUnNum:{},countryByISONum:{},xFilter:{},xFilterByReporter:{},xFilterByPartner:{},xFilterByYear:{},xFilterByCommodity:{},xFilterByFlow:{},xFilterByAmount:{},commodityName:function(t){try{var e=this.commodityCodes.get(t).text;return e.slice(e.indexOf(" - ")+3)}catch(r){return DEBUG&&console.warn("There was a problem getting a commodity name: "+r),"unknown"}},numFormat:function(t,e,r){r=r?"."+r:".1";var o=d3.format("$,"+r+"f");return 0===t?"0":"number"!=typeof t||isNaN(t)?"No data":Math.abs(t)>=1e9?o(Math.round(t/1e8)/10)+" bn":Math.abs(t)>=1e6?o(Math.round(t/1e5)/10)+" m":Math.abs(t)>=1e3?o(Math.round(t/100)/10)+" th":(o=d3.format("$,f"))(t)},numFormatFull:function(t){var e=d3.format("$,");return e(t)},numOrdinal:function(t){if(isNaN(t)||t%1)return t;if(20>t&&t>10)return t+"th";var e=t.toString().slice(-1),r="";switch(e){case"1":r=t+"st";break;case"2":r=t+"nd";break;case"3":r=t+"rd";break;default:r=t+"th"}return r},setup:function(e){"comtrade.un.org"===location.host||Modernizr.cors||(t.baseQueryUrl="proxy.php?fmt=csv&max=50000&type=C&freq=A&px=HS&rg=1%2C2",t.useCors=!1),"comtrade.un.org"!==location.host&&Modernizr.cors&&(t.baseQueryUrl="http://comtrade.un.org/api/get?fmt=csv&max=50000&type=C&freq=A&px=HS&rg=1%2C2",t.useCors=!0),"comtrade.un.org"===location.host&&(t.baseQueryUrl="/api/get?fmt=csv&max=50000&type=C&freq=A&px=HS&rg=1%2C2",t.useCors=!1);var r={dataType:"json"};$.when($.ajax("data/reporterAreas.min.json",r),$.ajax("data/partnerAreas.min.json",r),$.ajax("data/classificationHS_AG2.min.json",r),$.ajax("data/isoCodes.csv"),$.ajax("data/world-110m.json",r)).then(function(r,o,n,a,i){t.reporterAreasSelect=r[0].results,t.partnerAreasSelect=o[0].results,t.commodityCodesSelect=n[0].results,t.worldJson=i[0];var l=d3.csv.parse(a[0]);t.countryByUnNum=d3.map(l,function(t){return t.unCode}),t.reporterAreas=d3.map(r[0].results,function(t){return t.id}),t.flowByCode=d3.map([{id:"1",text:"imports"},{id:"2",text:"exports"},{id:"0",text:"balance"}],function(t){return t.id}),t.partnerAreas=d3.map(o[0].results,function(t){return t.id}),t.commodityCodes=d3.map(n[0].results,function(t){return t.id}),t.countryByISONum=d3.map(l,function(t){return t.isoNumerical}),t.areasByISONum=function(t){return l.filter(function(e){return+e.isoNumerical===+t})},t.lookup=function(e,r,o){try{return t[r].get(e)[o]}catch(n){return"unknown"}},t.reporterAreasSelect=t.reporterAreasSelect.filter(function(t){return"all"!==t.id}),t.partnerAreasSelect=t.partnerAreasSelect.filter(function(t){return"all"!==t.id}),t.commodityCodesSelect=t.commodityCodesSelect.filter(function(t){return"ALL"!==t.id&&"AG2"!==t.id}),e()},function(){e("There was an error with one of the initial requests.")}),this.xFilter=crossfilter(),this.xFilterByReporter=this.xFilter.dimension(function(t){return+t.reporter}),this.xFilterByPartner=this.xFilter.dimension(function(t){return+t.partner}),this.xFilterByYear=this.xFilter.dimension(function(t){return+t.year}),this.xFilterByCommodity=this.xFilter.dimension(function(t){return t.commodity}),this.xFilterByFlow=this.xFilter.dimension(function(t){return+t.flow}),this.xFilterByAmount=this.xFilter.dimension(function(t){return+t.value})},query:function(e,r){var o=this._buildUrl(e),n=new Date;if(t.queryHistory.indexOf(o)>-1)return void r(null,!0);var a=n.getTime()-t.timestamp;return 1100>a||t.queryRunning.indexOf(o)>-1?(window.setTimeout(function(){t.query(e,r)},a+100),this.queryQueue.indexOf(o)<0&&this.queryQueue.push(o),void r(null,!1)):void $.ajax({url:o,timeout:75e3,crossDomain:t.useCors,context:this,beforeSend:function(t){this.timestamp=n.getTime(),this.queryRunning.push(o),$("#loadingDiv #cancelRequest").on("click",function(){t.abort(),$("#loadingDiv").fadeOut()}),$("#loadingDiv").fadeIn()},success:function(t){this._addData(t,e),this.queryHistory.push(o);var n=this.queryRunning.indexOf(o);n>-1&&this.queryRunning.splice(n,1);var a=this.queryQueue.indexOf(o);a>-1&&this.queryQueue.splice(a,1),r(null,!0)},error:function(e,n,a){var i=this.queryRunning.indexOf(o);i>-1&&this.queryRunning.splice(i,1);var l=this.queryQueue.indexOf(o);l>-1&&this.queryQueue.splice(l,1),409===e.status?(DEBUG&&console.log("API 409 Error: Requeueing the request."),t.query(o,r),r(null,!1)):r(n+" "+a,null)},complete:function(){0===this.queryQueue.length&&0===this.queryRunning.length&&($("#loadingDiv").fadeOut(),$("#loadingDiv #cancelRequest").off("click"))}})},getData:function(t,e){this.xFilterByReporter.filterAll(),this.xFilterByPartner.filterAll(),this.xFilterByYear.filterAll(),this.xFilterByCommodity.filterAll(),this.xFilterByFlow.filterAll(),this.xFilterByAmount.filterAll(),"undefined"!=typeof t.reporter&&this.xFilterByReporter.filter(+t.reporter),"undefined"!=typeof t.partner&&"all"===t.partner&&this.xFilterByPartner.filter(function(t){return 0!==+t}),"undefined"!=typeof t.partner&&"all"!==t.partner&&this.xFilterByPartner.filter(+t.partner),"undefined"!=typeof t.year&&"all"!==t.year&&this.xFilterByYear.filter(+t.year),"undefined"!=typeof t.commodity&&"AG2"!==t.commodity&&this.xFilterByCommodity.filter(t.commodity),"undefined"!=typeof t.commodity&&"AG2"===t.commodity&&this.xFilterByCommodity.filter(function(t){return"TOTAL"!==t}),"undefined"==typeof t.commodity&&this.xFilterByCommodity.filter(function(t){return"TOTAL"===t}),"undefined"!=typeof t.flow&&0!==+t.flow&&this.xFilterByFlow.filter(t.flow),e||(e=1/0);var r=this.xFilterByAmount.top(e);return r},combineData:function(t){var e=[],r=d3.map(),o=0,n=0,a={};return t=t.filter(function(t){return 0!==+t.partner?!0:(1===t.flow&&(o=t.value,a.reporter=t.reporter,a.partner=t.partner,a.commodity=t.commodity,a.year=t.year,a.importVal=t.value),2===t.flow&&(n=t.value,a.reporter=t.reporter,a.partner=t.partner,a.commodity=t.commodity,a.year=t.year,a.exportVal=t.value),!1)}),a.bilateralVal=a.importVal+a.exportVal,a.balanceVal=a.exportVal-a.importVal,t.forEach(function(t){var e=["importVal","exportVal"][+t.flow-1],o=$.extend({},t);if(o.importVal=null,o.exportVal=null,o[e]=o.value,delete o.value,r.has(o.partner)){var n=r.get(o.partner);n[e]=o[e],r.set(n.partner,n)}else r.set(o.partner,o)}),e=r.values(),e=e.map(function(t){return t.importVal&&t.exportVal&&(t.bilateralVal=t.exportVal+t.importVal,t.balanceVal=t.exportVal-t.importVal),t.importVal&&0!==o&&(t.importPc=t.importVal/o/100),t.exportVal&&0!==n&&(t.exportPc=t.exportVal/n/100),t}),e.sort(function(t,e){return+(e.importVal>t.importVal)||+(e.importVal===t.importVal)-1}),e.forEach(function(t,r){t.importVal&&(e[r].importRank=r+1)}),e.sort(function(t,e){return+(e.exportVal>t.exportVal)||+(e.exportVal===t.exportVal)-1}),e.forEach(function(t,r){t.exportVal&&(e[r].exportRank=r+1)}),e.push(a),e},_buildUrl:function(e){var r=t.baseQueryUrl;return r+="undefined"!=typeof e.reporter?"&r="+e.reporter:"&r=0",r+="undefined"!=typeof e.partner?"&p="+e.partner:"&p=all",r+="undefined"!=typeof e.year&&null!==e.year?"&ps="+e.year:"&ps=now",r+="undefined"!=typeof e.commodity?"&cc="+e.commodity:"&cc=AG2"},_addData:function(t,e){var r=d3.csv.parse(t,function(t){return{reporter:+t["Reporter Code"],partner:+t["Partner Code"],year:+t.Year,commodity:t["Commodity Code"],flow:+t["Trade Flow Code"],value:+t["Trade Value (US$)"]}}),o=$.extend({},e);"all"==o.partner&&delete o.partner;var n=this.getData(o),a=[],i=r.filter(function(t){var e=!1;return n.forEach(function(r){t.reporter===r.reporter&&t.partner===r.partner&&t.commodity===r.commodity&&t.flow===r.flow&&t.year===r.year&&t.value===r.value&&(e=!0,a.push(t))}),!e});this.xFilter.add(i),DEBUG&&(console.groupCollapsed("%s query: r=%s p=%s c=%s y=%s",e.initiator,e.reporter,e.partner,e.commodity,e.year),console.log("filters: %o",e),console.log("Added %d new records. Retrieved %d records. Checked %d possible matches and discarded %d duplicates. New xFilter size: %d",i.length,r.length,n.length,a.length,this.xFilter.size()),console.log("duplicates discarded: %o",a),console.groupEnd())}};return t};return t()}),define("helpers/gui",[],function(){"use strict";var t={setup:function(){$("#footer").show(),$("#goToCharts a, #goToMap a").tooltip(),$(".titleDropdown button").tooltip(),$("#goToCharts a, #goToMap a, #goToFooter").on("click",function(t){t.preventDefault();var e=this.hash;$("html, body").animate({scrollTop:$(e).offset().top},1e3,function(){})}),$("#facebookShareLink").on("click",function(t){t.preventDefault();var e=screen.height/2-260,r=screen.width/2-175;window.open("https://www.facebook.com/sharer/sharer.php?u="+window.location.href,"sharer","top="+e+",left="+r+",toolbar=0,status=0,width=520,height=350")}),$("#tweetLink").on("click",function(t){t.preventDefault();var e=screen.height/2-260,r=screen.width/2-175;window.open("https://twitter.com/share?text=Check%20out%20the%20International%20Trade%20in%20Goods%20DataViz&url="+window.location.href,"sharer","top="+e+",left="+r+",toolbar=0,status=0,width=520,height=350")}),Modernizr.blobconstructor?$("a.downloadChart").on("click",function(){var t=$(this).attr("data-target"),e=$(this).attr("data-format"),r=$("#"+t+" .chartTitle").text(),o=$("#"+t+" .svgChart"),n=o.width(),a=o.height(),i=a,l=document.createRange(),s=document.createElement("div");l.selectNode(o[0]);var c=l.cloneContents();"choropleth"===t&&("svg"===e&&(n=1280,a=720,$(c).children("svg").removeAttr("viewBox").removeAttr("preserveAspectRatio").attr("width",n).attr("height",a)),i=645,$(c).children("svg").append('<g class="legend" transform="translate(25,25) scale(1.5)">'+$("#mapLegendSvg g.legend")[0].innerHTML+"</g>")),$(c).children("svg").attr("height",a+75).append('<text y="'+i+'"><tspan x="10" class="creditTitle">'+r+'</tspan><tspan x="10" dy="15" class="creditSource">International Trade in Goods based on UN Comtrade data</tspan><tspan x="10" dy="15" class="creditSource">Developed by the Department for Business Innovation and Skills (UK)</tspan><tspan x="10" dy="15" class="creditLink">'+document.location.href+"</tspan></text>"),s.appendChild(c.cloneNode(!0));var d=s.innerHTML;if("svg"==e){var p=new Blob([d],{type:"image/svg+xml;charset=utf8"});return void saveAs(p,t+".svg")}if("png"==e){var u=new Image;u.onload=function(){var e=document.createElement("canvas");e.width=n,e.height=a+75;var r=e.getContext("2d");r.drawImage(u,0,0);var o=document.createElement("a");o.download=t+".png";var i=e.toDataURL("image/png");o.href=i,document.body.appendChild(o),o.click()},u.src="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(d)))}}):$("a.downloadChart").hide(),$("a.embedSvg").on("click",function(t){t.preventDefault(),$("#myModal #myModalLabel").html("Embed this chart"),$("#myModal .modal-body").html("<p>Copy and paste the following code:</p><pre>&lt;iframe src=&quot;"+window.location.href+"&amp;embed="+$(this).attr("data-target")+'&quot; height=&quot;500&quot; width=&quot;100%&quot;&gt;&lt;/iframe&gt;</pre><p>Preview:</p><iframe src="'+window.location.href+"&embed="+$(this).attr("data-target")+'" height="500" width="100%"></iframe>'),$("#myModal").modal("show")}),$("body").on("hidden.bs.modal",".modal",function(){$(this).removeData("bs.modal")})},showError:function(t){$("#myModalLabel").html('<span class="glyphicon glyphicon-warning-sign"></span> There was an error in querying the COMTRADE API.'),$("#myModal .modal-body").html("Charts may not display correctly, please try reloading the page or trying again later.<br /><small>Error details: "+t+"</small>"),$("#myModal").modal({show:!0})},downloadCsv:function(t,e){var r="data:text/csv;charset=utf-8,\nreporter,partner,flow,commodity,year,value\n";e.forEach(function(t){r+=t.reporter+","+t.partner+","+t.flow+","+t.commodity+","+t.year+","+t.value+"\n"});var o=encodeURI(r),n=document.createElement("a");n.setAttribute("href",o),n.setAttribute("download",t+".csv"),document.body.appendChild(n),n.click()}};return t}),define("helpers/controls",["./data"],function(t){"use strict";var e={$selectReporter:$("#selectReporter"),$selectPartner:$("#selectPartner"),$selectCommodity:$("#selectCommodity"),$selectYear:$("#selectYear"),$selects:$("#selectReporter, #selectPartner, #selectCommodity, #selectYear"),$flowButtons:$("#flowButtons"),$clearFilters:$("#clearFilters"),filters:{},setup:function(){$("#navbar").show(),this.$selectReporter.select2({placeholder:"Select a reporter",allowClear:!0,data:t.reporterAreasSelect}).on("change",e.onFilterChange),this.$selectPartner.select2({placeholder:"Select a partner",allowClear:!0,disabled:!0,data:t.partnerAreasSelect}).on("change",e.onFilterChange).select2("disable"),this.$selectCommodity.select2({placeholder:"Select a commodity",allowClear:!0,data:t.commodityCodesSelect}).on("change",e.onFilterChange).select2("disable"),this.$selectYear.select2({allowClear:!1,minimumResultsForSearch:1/0,disabled:!0}).on("change",e.onFilterChange),this.$flowButtons.on("click",function(t){$("#flowButtons button").removeClass("btn-primary").addClass("btn-default"),$(t.target).closest("button").removeClass("btn-default").addClass("btn-primary"),e.onFilterChange()}),this.$clearFilters.on("click",function(){$("#selectReporter, #selectPartner, #selectCommodity").off("change",e.onFilterChange).val(null).trigger("change").on("change",e.onFilterChange),e.onFilterChange()}),$("#closeContextMenu").on("click",function(t){t.preventDefault(),$("#contextMenu").hide()}),$("#contextMenu .setReporter").on("click",function(t){t.preventDefault(),$(t.target.parentNode).hasClass("disabled")||e.changeFilters({reporter:$(t.target).attr("data-uncode")}),$("#contextMenu").hide()}),$("#contextMenu .setPartner").on("click",function(t){t.preventDefault(),$(t.target.parentNode).hasClass("disabled")||e.changeFilters({partner:$(t.target).attr("data-uncode")}),$("#contextMenu").hide()})},getFilters:function(){var t={};return""!==e.$selectReporter.val()&&(t.reporter=e.$selectReporter.val()),""!==e.$selectPartner.val()&&(t.partner=e.$selectPartner.val()),""!==e.$selectCommodity.val()&&(t.commodity=e.$selectCommodity.val()),""!==e.$selectYear.val()&&(t.year=e.$selectYear.val()),""!==$("#flowButtons .btn-primary").attr("data-value")&&(t.flow=$("#flowButtons .btn-primary").attr("data-value")),t},onFilterChange:function(){var t=e.getFilters();(e.filters.reporter!==t.reporter||e.filters.partner!==t.partner||e.filters.commodity!==t.commodity||e.filters.year!==t.year||e.filters.flow!==t.flow)&&(!e.filters.partner&&t.partner&&$("html, body").animate({scrollTop:$("#charts").offset().top},2e3),DEBUG&&console.log("New filters: %s",JSON.stringify(t)),e.fadeControls(t),e.showElements(t),$(".chart").trigger("refreshFilters",t),e.updateURL(t),e.filters=t)},changeFilters:function(t){(t.reporter||""!==e.$selectReporter.val())&&(t.reporter&&t.reporter!==e.$selectReporter.val()&&e.$selectReporter.val(t.reporter),t.commodity&&t.commodity!==e.$selectCommodity.val()&&e.$selectCommodity.val(t.commodity),t.partner&&t.partner!==e.$selectPartner.val()&&e.$selectPartner.val(t.partner),t.year&&t.year!==e.$selectYear.val()&&(e.updateYears([+e.$selectYear.val(),t.year]),e.$selectYear.val(t.year)),e.$selects.trigger("change"))},initializeFilters:function(){var t=this.decodeURL();t&&t.reporter?this.changeFilters(t):e.changeFilters({reporter:826,year:2014})},decodeURL:function(){var t=window.History;try{var e={},r=t.getState();return r.hash.split("?",2)[1].split("&").forEach(function(t){t=t.replace(/%20|\+/g," ").split("="),e[decodeURIComponent(t[0])]=t[1]?decodeURIComponent(t[1]):void 0}),e.year&&(e.year=+e.year),e}catch(o){return{}}},updateURL:function(t){var e=window.History,r="?",o="";for(o in t)r+=encodeURIComponent(o),t[o]&&(r+="="+encodeURIComponent(t[o])),r+="&";r=r.slice(0,-1),e.replaceState(null,"International Trade in Goods by Country and Commodity",r)},updateYears:function(t){if(t.length>0){var r=+e.$selectYear.val();e.$selectYear.html(""),t.sort(function(t,e){return e-t}).forEach(function(t){e.$selectYear.append('<option value="'+t+'">'+t+"</option>")}),t.indexOf(r)>=0?e.$selectYear.val(+r):e.$selectYear.val(d3.max(t)).trigger("change")}},fadeControls:function(t){t.reporter?($("#selectCommodity").select2("enable"),$("#selectPartner").select2("enable"),$("#selectYear").select2("enable")):($("#selectReporter, #selectPartner, #selectCommodity").off("change",e.onFilterChange).val(null).trigger("change").on("change",e.onFilterChange),$("#selectCommodity").select2("disable"),$("#selectPartner").select2("disable"),$("#selectYear").select2("disable"))},showElements:function(t){t.reporter?($("#goToCharts, #goToMap, #flowButtons").show(),$("#charts").slideDown(),$("#contextMenu .setPartner").removeClass("disabled")):($("#goToCharts, #goToMap, #flowButtons").hide(),$("#charts").slideUp(),$("#contextMenu .setPartner").addClass("disabled"))},showError:function(t){$("#myModalLabel").html('<span class="glyphicon glyphicon-warning-sign"></span> There was an error in querying the COMTRADE API.'),$("#myModal .modal-body").html(t),$("#myModal").modal({show:!0})}};return e}),define("helpers/charts/infoBox",["../data","../gui","../controls"],function(t,e){"use strict";var r=t,o=$("#infoBox"),n=$("#defaultPanel"),a=$("#hoverPanel"),i=10,l=function(){return $(document).width()>992?Math.min($("#infoBoxPlaceholder").offset().top,$(window).height()-o.height()-i+$(window).scrollTop())+"px":$("#infoBoxPlaceholder").offset().top},s=function(){return $("#infoBoxPlaceholder").width()-20+"px"},c=function(){o.css({top:l(),width:s()})},d={setup:function(){o.show().css({top:$(window).height()-o.height()-i+$(window).scrollTop(),width:s()}),$(window).scroll(c),a.slideUp(),$(window).on("resize",c),o.on("refreshFilters",this.refresh)},refresh:function(a,i){if(!i.reporter)return void o.slideUp();o.slideDown();var l={reporter:+i.reporter,partner:0,year:+i.year,commodity:"AG2",initiator:"infoBox"},s={reporter:+i.reporter,year:+i.year,commodity:"TOTAL"};i.partner&&0!==i.partner||(s.partner=0),!i.reporter||i.commodity||i.partner||(l.commodity="TOTAL",l.year="all"),i.reporter&&!i.commodity&&i.partner&&(l.partner="all",l.commodity="TOTAL",l.year=+i.year),i.reporter&&i.commodity&&i.partner&&(l.partner="all",l.commodity=i.commodity,s.commodity=i.commodity),i.reporter&&i.commodity&&!i.partner&&(l.partner="all",l.commodity=i.commodity,s.commodity=i.commodity),t.query(l,function(t,o){if(t&&e.showError(t),!t&&o){var a=r.getData(s),l=r.combineData(a),c=d3.map(l,function(t){return t.partner});d.populateBox(n,c.get(i.partner||0),i.partner)}})},populateBox:function(t,e,o){if(t.find(".subtitle").html(""),t.find(".value").html(""),t.find(".ranking").html(""),t.find("dt").show(),!e)return t.find(".subtitle").html('<p class="text-center"><strong>No data available for '+r.lookup(o,"countryByUnNum","name")+".</strong></p>"),t.find(".value, .ranking").html(""),void t.find("dt").hide();var n=r.lookup(e.reporter,"reporterAreas","text"),a=r.lookup(e.partner,"partnerAreas","text"),i="<strong>"+n+"</strong> trade in goods with <strong>"+a+"</strong> in <strong>"+e.year+"</strong><br />";if(e.commodity&&"TOTAL"!==e.commodity&&(i+="<strong>"+r.commodityName(e.commodity)+"</strong>"),t.find(".subtitle").html(i),t.find(".value.exports").html(r.numFormat(e.exportVal,null,1)),t.find(".value.imports").html(r.numFormat(e.importVal,null,1)),t.find(".value.balance").html(r.numFormat(e.balanceVal,null,1)),t.find(".value.bilateral").html(r.numFormat(e.bilateralVal,null,1)),e.partner&&0!==e.partner&&e.importRank&&e.exportRank){var l=a+" was the "+r.numOrdinal(e.exportRank)+" largest export market for "+n+" ("+e.exportPc.toFixed(1)+"% of "+n+" exports) and the "+r.numOrdinal(e.importRank)+" largest import market for "+n+" ("+e.importPc.toFixed(1)+"% of "+n+" imports)";e.commodity&&"TOTAL"!==e.commodity&&(l+=" for "+r.commodityName(e.commodity)),l+=" in "+e.year+".",t.find(".ranking").html(l)}},displayHover:function(t,e){d.populateBox(a,t,e),n.stop().slideUp(),a.stop().slideDown()},hideHover:function(){a.stop().slideUp(),n.stop().slideDown()}};return d}),define("helpers/charts/choropleth",["../data","../gui","./infoBox","../controls"],function(t,e,r){"use strict";var o=t,n=$("#choropleth"),a=$("#choroplethTitle .chartTitle"),i=720,l=1280,s=d3.select("#choropleth .chart").append("svg").classed("choropleth",!0).classed("svgChart",!0).attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").attr("id","choroplethSvg").attr("viewBox","0 0 "+l+" "+i).attr("preserveAspectRatio","xMidYMid meet"),c={setup:function(e){n.show(),n.on("refreshFilters",this.refresh);var a=d3.geo.kavrayskiy7().scale(230).translate([l/2+50,i/2]).precision(.1),c=d3.geo.path().projection(a),d=function(){s.attr("width",n.width()).attr("height",n.height())};d(),d3.select(window).on("resize",d),s.append("defs").append("path").datum({type:"Sphere"}).attr("id","sphere").attr("d",c).attr("stroke","#054D82").attr("stroke-width","1.5px").attr("fill","none"),s.append("use").attr("class","stroke").attr("xlink:href","#sphere"),s.append("use").attr("class","fill").attr("xlink:href","#sphere");var p=topojson.feature(t.worldJson,t.worldJson.objects.countries).features;s.append("g").attr("class","countries").selectAll(".country").data(p).enter().append("path").attr("class","country").attr("d",c).attr("id",function(t){return"iso"+t.id}).on("click",function(t){d3.event.preventDefault(),$("#contextMenu .country").html(o.lookup(t.id,"countryByISONum","name")),$("#contextMenu .setReporter a, #contextMenu .setPartner a").attr("data-uncode",o.lookup(t.id,"countryByISONum","unCode")),$("#closeContextMenu").on("click",function(t){t.preventDefault(),r.hideHover()}),$("#contextMenu").css({display:"block",left:d3.event.pageX,top:d3.event.pageY})}),e&&e()},refresh:function(r,i){var l={reporter:+i.reporter,partner:"all",year:+i.year,initiator:"choropleth"},d={reporter:+i.reporter,partner:"all",year:+i.year,flow:+i.flow},p="";return i.reporter?(i.reporter&&!i.commodity&&(l.commodity="TOTAL",d.commodity="TOTAL",p=o.lookup(i.reporter,"countryByUnNum","name")+[" trade in goods balance "," imports of goods "," exports of goods "][i.flow]+" in "+i.year),i.reporter&&i.commodity&&(l.commodity=i.commodity,d.commodity=i.commodity,p=o.lookup(i.reporter,"countryByUnNum","name")+[" trade in "+o.commodityName(i.commodity)+" balance "," imports of "+o.commodityName(i.commodity)+" "," exports of "+o.commodityName(i.commodity)+" "][i.flow]+" in "+i.year),void t.query(l,function(t,r){t&&e.showError(t),!t&&r&&(c._redrawMap(d),a.html(p),n.find(".downloadData").on("click",function(t){t.preventDefault(),e.downloadCsv(p,newData)}))})):(s.selectAll(".country").style("fill","#fff"),s.selectAll(".highlighted").classed("highlighted",!1),void a.html(""))},_redrawMap:function(t){var e,n;1===+t.flow&&(e="importRank",n="importVal"),2===+t.flow&&(e="exportRank",n="exportVal"),0===+t.flow&&(e="balanceVal",n="balanceVal");var a=o.getData({reporter:t.reporter,commodity:t.commodity,year:+t.year});a=o.combineData(a),a=a.filter(function(t){return t[e]&&t[n]&&0!==t.partner});var i,l,d=d3.map(a,function(t){return t.partner}),p=a.length,u=d3.scale.threshold();0===+t.flow?u.domain([0]).range([0,1]):(p>25&&(i=[4,p/4,p/2,3*p/4],l=[4,3,2,1,0]),25>=p&&p>4&&(i=[p/4,p/2,3*p/4],l=[3,2,1,0]),4>=p&&(i=[p],l=[0]),u=d3.scale.threshold().domain(i).range(l)),s.selectAll(".country").classed("highlighted",!1).on("mouseenter",function(t){try{var e=o.countryByISONum.get(t.id).unCode,n=d.get(e);n?r.displayHover(n):r.displayHover(!1,e),s.selectAll(".country").sort(function(e,r){return(e.id===t.id)-(r.id===t.id)})}catch(a){r.displayHover(!1),DEBUG&&console.log("No country in database by "+t.id+" isoCode.")}}).on("mouseleave",function(){r.hideHover()}).transition().duration(1e3).style("fill",function(r){var n=o.areasByISONum(r.id),a=[],i=0;try{if(n.forEach(function(t){var e=d.get(t.unCode);e&&a.push(d.get(t.unCode))}),0===a.length)throw"No data points for "+o.lookup(r.id,"countryByUnNum","name");if(a.length>1)throw"Multiple data points for "+o.lookup(r.id,"countryByUnNum","name");if(null===a[0][e])throw"Incomplete data for "+o.lookup(r.id,"countryByUnNum","name");return i=u(a[0][e]),c.colors[t.flow][i]}catch(l){return"#818181"}});var m=d3.nest().key(function(t){return u(t[e])}).rollup(function(t){return{min:d3.min(t,function(t){return t[n]}),max:d3.max(t,function(t){return t[n]}),count:t.length}}).entries(a);c._drawLegend(m,t.flow),s.select("#iso"+o.lookup(t.reporter,"countryByUnNum","isoNumerical")).classed("highlighted",!0)},_drawLegend:function(t,e){var r=d3.select("#mapLegend svg"),n=30,a=5,i=c.colors[e].slice(0,t.length),l=["Balance","Imports","Exports"][e],s=t.reduce(function(t,e){return t+e.values.count},0);r.attr("height",(t.length+1)*(n+a)+25).attr("width",225),r.select("g.legend").remove(),r.select("text.title").remove(),r.append("text").attr("class","title").attr("x",0).attr("y",18).style("font-weight","bold").text(l+" Legend");var d=r.append("g").attr("class","legend").attr("transform","translate(0,25)");d.append("rect").attr("class","noData").attr("x",0).attr("y",0).attr("rx",1).attr("ry",1).attr("width",8).attr("height",15).style("fill","#818181"),d.append("text").attr("class","noData").attr("x",12).attr("y",13).text("No data available"),d=d.append("g").attr("class","scale").attr("transform","translate(0,18)"),d.selectAll("rect").data(d3.range(i.length)).enter().append("rect").attr("x",0).attr("y",function(t,e){return 33*e}).attr("rx",1).attr("ry",1).attr("width",8).attr("height",30).style("fill",function(t,e){return i[e]});var p=d.selectAll("text").data(d3.range(i.length)).enter().append("text").attr("y",function(t,e){return 33*e+14});p.append("tspan").attr("class","line1").attr("x",12).text(function(r,n){return+e>0?o.numFormat(t[n].values.min,null,1)+" - "+o.numFormat(t[n].values.max,null,1)+" ("+t[n].values.count+" partners)":void 0}),p.append("tspan").attr("class","line1").attr("x",12).attr("dy",15).text(function(r,o){if(0===+e)return["Deficit","Surplus"][o]+" ("+t[o].values.count+" partners)";var n="";switch(o){case 0:n=4>s?"Not enough data to map":"Up to 25th percentile";break;case 1:n="25th to 50th percentile";break;case 2:n="50th to 75th percentile";break;case 3:n="Above 75th percentile excl. top 3";break;case 4:var a=3/s*100;n="Top 3 - above "+a.toFixed(1)+" percentile"}return n})}};return c}),define("helpers/charts/yearChart",["../data","../gui","../controls"],function(t,e,r){"use strict";var o=t,n=$("#yearChart"),a=n.children(".chart"),i=n.children(".chartTitle"),l=d3.select("#yearChart .chart").append("svg").attr("xmlns","http://www.w3.org/2000/svg").attr("version",1.1).classed("svgChart",!0),s={top:25,right:15,bottom:75,left:70},c=a.height(),d=a.width(),p=c-s.top-s.bottom,u=d-s.left-s.right,m=d3.scale.linear().range([0,u]).clamp(!0),f=d3.scale.linear().range([p,0]),h=d3.svg.axis().scale(m).orient("bottom").tickFormat(d3.format(".0f")),y=d3.svg.axis().scale(f).orient("left").ticks(6).tickFormat(o.numFormat),g=d3.svg.line().interpolate("linear"),v={setup:function(){a.on("refreshFilters",this.refresh),$(window).on("resize",this.resizeSvg),l.attr("width",d).attr("height",c),l.append("g").attr("class","x axis").attr("transform","translate("+s.left+","+(s.top+p)+")").call(h),l.append("g").attr("class","y axis").attr("transform","translate("+s.left+","+s.top+")").call(y),l.append("g").attr("class","plots").attr("transform","translate("+s.left+","+s.top+")");var t=l.append("g").attr("class","legend").attr("transform","translate("+(u+s.left-120*v.colors[0].length)+",0)").selectAll(".legendItem").data(v.colors[0]).enter().append("g").attr("class","legendItem");t.append("circle").attr("cx",function(t,e){return 120*e}).attr("cy","10").attr("r","5").style("fill",function(t){return t}),t.append("text").attr("transform",function(t,e){return"translate("+(120*e+10)+",15)"}).text(function(t,e){return["Imports","Exports"][e]}),n.slideUp(0)},refresh:function(r,a){if(!a.reporter)return void n.slideUp();var l={reporter:+a.reporter,year:"all",initiator:"yearChart"},s={reporter:+a.reporter,year:"all"},c="";!a.reporter||a.commodity||a.partner||(c=o.lookup(a.reporter,"reporterAreas","text")+" trade in goods with the world",l.partner=0,l.commodity="TOTAL",s=l),a.reporter&&!a.commodity&&a.partner&&(c=o.lookup(a.reporter,"reporterAreas","text")+" trade in goods with "+o.lookup(a.partner,"partnerAreas","text"),l.partner=a.partner,l.commodity="TOTAL",s.partner=+a.partner,s.commodity="TOTAL"),a.reporter&&a.commodity&&a.partner&&(c=o.lookup(a.reporter,"reporterAreas","text")+" trade in "+o.commodityName(a.commodity)+" with "+o.lookup(a.partner,"partnerAreas","text"),l.partner=+a.partner,l.commodity=a.commodity,s.partner=+a.partner,s.commodity=a.commodity),a.reporter&&a.commodity&&!a.partner&&(c=o.lookup(a.reporter,"reporterAreas","text")+" trade in "+o.commodityName(a.commodity)+" with the world",l.partner=0,l.commodity=a.commodity,s.partner=0,s.commodity=a.commodity),t.query(l,function(t,r){if(t&&e.showError(t),!t&&r){var a=o.getData(s),l=d3.min(a,function(t){return t.year
});c+=" since "+l,i.html(c),n.find(".downloadData").on("click",function(t){t.preventDefault(),e.downloadCsv(c,a)}),n.slideDown(400,function(){v._draw(a)})}})},_draw:function(t){if(0===t.length)return l.append("text").text("No data available for this chart.").classed("nodata",!0).classed("label",!0).attr("x",u/2+s.left-75).attr("y",p/2+s.top-75),void l.selectAll(".flow").remove();l.selectAll(".nodata").remove();var e=d3.nest().key(function(t){return t.flow}).sortValues(function(t,e){return t.year-e.year}).entries(t),n=d3.extent(t,function(t){return t.year}),a=d3.range(n[0],n[1]+1),i=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(t){return t.year+": "+o.numFormat(t.value,null,1)+" "+["imports","exports"][t.flow-1]});m.domain([n[0],n[1]+1]),f.domain([0,d3.max(t,function(t){return t.value})]),g.x(function(t){return m(t.year)}).y(function(t){return f(t.value)}),h.scale(m).tickValues(a).tickSize(6,0).tickFormat(d3.format(".0f")),y.scale(f).tickSize(6,0).tickFormat(o.numFormat),r.updateYears(a),l.select(".x.axis").transition().call(h).selectAll("g.x text").attr("transform","rotate(-65) translate(-22,-10)"),l.select(".y.axis").transition().call(y);var c=l.selectAll("line.yearHighlight").data([1]),d=$("#selectYear").val();c.enter().append("line").attr("class","yearHighlight").attr("x1","0").attr("y1",s.top).attr("x2","0").attr("y2",s.top+p).attr("stroke","#054D82").attr("stroke-dasharray","5, 5").attr("stroke-width","1"),c.transition().attr("x1",function(){return m(+d)+s.left}).attr("x2",function(){return m(+d)+s.left});var x=l.select(".plots"),w=x.selectAll("path.flow").data(e);w.enter().append("path").attr("class","flow").style("stroke",function(t){return v.colors[0][t.key-1]}).style("fill","none").style("stroke-width","1.5px"),w.transition().attr("d",function(t){return g(t.values)});var b=x.selectAll("g.flow").data(e);b.enter().append("g").attr("class","flow");var C=b.selectAll("circle.dot").data(function(t){return t.values});C.enter().append("circle").attr("class","dot").attr("r","3").style("fill",function(t){return v.colors[0][t.flow-1]}).style("stroke-width","0").on("mouseover",function(t){i.show(t),d3.select(this).interrupt().transition().attr("r","6")}).on("mouseout",function(t){i.hide(t),d3.select(this).interrupt().transition().attr("r","3")}).on("click",function(t){r.changeFilters({year:t.year})}),C.transition().attr("cx",function(t){return m(t.year)}).attr("cy",function(t){return f(t.value)}),C.exit().remove(),x.call(i)},resizeSvg:function(){d=a.width(),l.attr("width",d),u=d-s.left-s.right,m.range([0,u]),h.scale(m),l.select(".x.axis").transition().call(h),l.select("g.legend").attr("transform","translate("+(u+s.left-120*v.colors[0].length)+",0)"),l.selectAll("circle.dot").transition().attr("cx",function(t){return m(t.year)}),g.x(function(t){return m(t.year)}),l.selectAll("path.flow").transition().attr("d",function(t){return g(t.values)});var t=$("#selectYear").val();l.selectAll("line.yearHighlight").transition().attr("x1",function(){return m(+t)+s.left}).attr("x2",function(){return m(+t)+s.left})}};return v}),define("helpers/rowchart",["./data","./controls"],function(t,e){"use strict";var r=t,o={margin:{top:25,right:60,bottom:75,left:35},innerHeight:0,innerWidth:0,xScale:d3.scale.linear(),yScale:d3.scale.linear(),xAxis:d3.svg.axis().tickSize(0,0).tickFormat(""),yAxis:d3.svg.axis(),barHeight:0,setup:function(t){o.innerHeight=t.attr("height")-o.margin.top-o.margin.bottom,o.innerWidth=t.attr("width")-o.margin.left-o.margin.right,o.xScale.range([0,o.innerWidth]),o.yScale.range([0,o.innerHeight]).clamp(!0),o.xAxis.scale(o.xScale).orient("bottom").tickFormat(r.numFormat),o.yAxis.scale(o.yScale).orient("left"),t.append("g").attr("class","bars").attr("transform","translate("+o.margin.left+","+o.margin.top+")"),t.append("g").attr("class","x axis").attr("transform","translate("+o.margin.left+","+(o.innerHeight+o.margin.top)+")").call(o.xAxis),t.append("g").attr("class","y axis").attr("transform","translate("+o.margin.left+","+o.margin.top+")").call(o.yAxis)},draw:function(t,n,a,i){o.xScale.domain([0,d3.max(n,function(t){return t.value})]).nice(),o.yScale.domain([0,d3.max([10,n.length])]).clamp(!0).nice(),o.xAxis.scale(o.xScale).tickSize(6,0).tickFormat(r.numFormat),o.yAxis.scale(o.yScale).ticks(0),o.barHeight=o.yScale(1)-20,t.select("text.nodata").remove(),t.select(".x.axis").transition().call(o.xAxis).selectAll("text").attr("transform","rotate(-65) translate(-13,-10)").style("text-anchor","end"),t.select(".y.axis").transition().call(o.yAxis);var l=t.select(".bars").selectAll("g.item").data(n);l.enter().append("g").append("rect").attr("width","0").attr("height","0"),l.classed("item",!0).attr("transform",function(t,e){return"translate(0,"+o.yScale(e)+")"}),l.selectAll("g.item text").remove();var s=l.select("rect").on("click",function(t){e.changeFilters("all"===a.partner?{partner:t.partner}:{commodity:t.commodity})}),c=l.append("text").classed("label",!0),d=l.append("text").classed("value",!0);s.transition().attr("x",0).attr("y",o.yScale(1)-o.barHeight-5).style("fill",i).attr("height",o.barHeight).attr("width",function(t){return d3.max([0,o.xScale(+t.value)])}),c.attr("x","3").attr("y",o.yScale(1)-o.barHeight-8).text(function(t){return"all"===a.partner?r.lookup(t.partner,"partnerAreas","text"):r.commodityName(t.commodity)}),d.attr("x",function(t){return o.xScale(+t.value)+3}).attr("y",o.yScale(1)-5).text(function(t){return r.numFormat(t.value,null,1)}),l.exit().remove(),0===l.size()&&t.append("text").text("No data available for this chart.").classed("nodata",!0).classed("label",!0).attr("x",o.innerWidth/2+o.margin.left-75).attr("y",o.innerHeight/2+o.margin.top-75)},resizeSvg:function(t,e){t.attr("width",e),o.innerWidth=t.attr("width")-o.margin.left-o.margin.right,o.xScale.range([0,o.innerWidth]),o.xAxis.scale(o.xScale),t.select(".x.axis").transition().call(o.xAxis);var r=t.selectAll("g.item");r.selectAll("rect").attr("width",function(t){return o.xScale(+t.value)}),r.selectAll("text.value").attr("x",function(t){return o.xScale(+t.value)+3})}};return o}),define("helpers/charts/topExportCommodities",["../data","../rowchart","../gui","../controls"],function(t,e,r){"use strict";var o=t,n=$("#topExportCommodities"),a=n.children(".chart"),i=n.children(".chartTitle"),l=a.height(),s=a.width(),c=d3.select("#topExportCommodities .chart").append("svg").attr("xmlns","http://www.w3.org/2000/svg").attr("version",1.1).classed("svgChart",!0).attr("height",l).attr("width",s),d=10,p={setup:function(){a.on("refreshFilters",this.refresh),$(window).on("resize",function(){e.resizeSvg(c,a.width())}),e.setup(c),n.slideUp(0)},refresh:function(a,l){if(!l.reporter)return void n.slideUp();var s={reporter:+l.reporter,partner:0,year:+l.year,commodity:"AG2",initiator:"topExportCommodities"},u={reporter:+l.reporter,partner:0,year:+l.year,commodity:"AG2"},m="";return u.flow=2,!l.reporter||l.commodity&&"TOTAL"!==l.commodity||l.partner||(m=o.lookup(l.reporter,"reporterAreas","text")+" - Top-10 exports of goods to the world in "+l.year),!l.reporter||l.commodity&&"TOTAL"!==l.commodity||!l.partner||(m=o.lookup(l.reporter,"reporterAreas","text")+" - Top-10 exports of goods to "+o.lookup(l.partner,"partnerAreas","text")+" in "+l.year,s.partner=+l.partner,u.partner=+l.partner),l.reporter&&l.commodity&&"TOTAL"!==l.commodity&&l.partner?(i.html(""),void n.slideUp()):l.reporter&&l.commodity&&"TOTAL"!==l.commodity&&!l.partner?(i.html(""),void n.slideUp()):(i.html(m),void t.query(s,function(t,a){if(t&&r.showError(t),!t&&a){var l=o.getData(u,d);i.html(m),n.find(".downloadData").on("click",function(t){t.preventDefault(),r.downloadCsv(m,l)}),n.slideDown(400,function(){e.draw(c,l,u,p.colors[0][1])})}}))}};return p}),define("helpers/charts/topExportMarkets",["../data","../rowchart","../gui","../controls"],function(t,e,r){"use strict";var o=t,n=$("#topExportMarkets"),a=n.children(".chart"),i=n.children(".chartTitle"),l=a.height(),s=a.width(),c=d3.select("#topExportMarkets .chart").append("svg").attr("xmlns","http://www.w3.org/2000/svg").attr("version",1.1).classed("svgChart",!0).attr("height",l).attr("width",s),d=10,p={setup:function(){a.on("refreshFilters",this.refresh),$(window).on("resize",function(){e.resizeSvg(c,a.width())}),e.setup(c),n.slideUp(0)},refresh:function(a,l){if(!l.reporter)return void n.slideUp();var s={reporter:+l.reporter,partner:"all",year:l.year,commodity:"AG2",initiator:"topExportMarkets"},u={reporter:+l.reporter,partner:"all",year:l.year,commodity:"AG2"},m="";return u.flow=2,!l.reporter||l.commodity||l.partner&&0!==+l.partner||(m=o.lookup(l.reporter,"reporterAreas","text")+" - Top-10 export markets for goods in "+l.year,s.commodity="TOTAL",u.commodity="TOTAL"),l.reporter&&!l.commodity&&l.partner&&0!==+l.partner?(i.html(""),void n.slideUp()):l.reporter&&l.commodity&&l.partner&&0!==+l.partner?(i.html(""),void n.slideUp()):(!l.reporter||!l.commodity||l.partner&&0!==+l.partner||(m=o.lookup(l.reporter,"reporterAreas","text")+" - Top-10 export markets for "+o.commodityName(l.commodity)+" in "+l.year,s.commodity=l.commodity,u.commodity=l.commodity),void t.query(s,function(t,a){if(t&&r.showError(t),!t&&a){var l=o.getData(u,d);i.html(m),n.find(".downloadData").on("click",function(t){t.preventDefault(),r.downloadCsv(m,l)}),n.slideDown(400,function(){e.draw(c,l,u,p.colors[0][1])})}}))}};return p}),define("helpers/charts/topImportCommodities",["../data","../rowchart","../gui","../controls"],function(t,e,r){"use strict";var o=t,n=$("#topImportCommodities"),a=n.children(".chart"),i=n.children(".chartTitle"),l=a.height(),s=a.width(),c=d3.select("#topImportCommodities .chart").append("svg").attr("xmlns","http://www.w3.org/2000/svg").attr("version",1.1).classed("svgChart",!0).attr("height",l).attr("width",s),d=10,p={setup:function(){a.on("refreshFilters",this.refresh),$(window).on("resize",function(){e.resizeSvg(c,a.width())}),e.setup(c),n.slideUp(0)},refresh:function(a,l){if(!l.reporter)return void n.slideUp();var s={reporter:+l.reporter,partner:0,year:+l.year,commodity:"AG2",initiator:"topImportCommodities"},u={reporter:+l.reporter,partner:0,year:+l.year,commodity:"AG2"},m="";return u.flow=1,!l.reporter||l.commodity&&"TOTAL"!==l.commodity||l.partner||(m=o.lookup(l.reporter,"reporterAreas","text")+" - Top-10 imports of goods from the world in "+l.year),!l.reporter||l.commodity&&"TOTAL"!==l.commodity||!l.partner||(m=o.lookup(l.reporter,"reporterAreas","text")+" - Top-10 imports of goods from "+o.lookup(l.partner,"partnerAreas","text")+" in "+l.year,s.partner=+l.partner,u.partner=+l.partner),l.reporter&&l.commodity&&"TOTAL"!==l.commodity&&l.partner?(i.html(""),void n.slideUp()):l.reporter&&l.commodity&&"TOTAL"!==l.commodity&&!l.partner?(i.html(""),void n.slideUp()):void t.query(s,function(t,a){if(t&&r.showError(t),!t&&a){var l=o.getData(u,d);i.html(m),n.find(".downloadData").on("click",function(t){t.preventDefault(),r.downloadCsv(m,l)}),n.slideDown(400,function(){e.draw(c,l,u,p.colors[0][0])})}})}};return p}),define("helpers/charts/topImportMarkets",["../data","../rowchart","../gui","../controls"],function(t,e,r){"use strict";var o=t,n=$("#topImportMarkets"),a=n.children(".chart"),i=n.children(".chartTitle"),l=a.height(),s=a.width(),c=d3.select("#topImportMarkets .chart").append("svg").attr("xmlns","http://www.w3.org/2000/svg").attr("version",1.1).classed("svgChart",!0).attr("height",l).attr("width",s),d=10,p={setup:function(){a.on("refreshFilters",this.refresh),$(window).on("resize",function(){e.resizeSvg(c,a.width())}),e.setup(c),n.slideUp(0)},refresh:function(a,l){if(!l.reporter)return void n.slideUp();var s={reporter:+l.reporter,partner:"all",year:l.year,commodity:"AG2",initiator:"topImportMarkets"},u={reporter:+l.reporter,partner:"all",year:l.year,commodity:"AG2"},m="";return u.flow=1,!l.reporter||l.commodity||l.partner&&0!==+l.partner||(s.commodity="TOTAL",u.commodity="TOTAL",m=o.lookup(l.reporter,"reporterAreas","text")+" - Top-10 import markets for goods in "+l.year),l.reporter&&!l.commodity&&l.partner&&0!==+l.partner?(i.html(""),void n.slideUp()):l.reporter&&l.commodity&&l.partner&&0!==+l.partner?(i.html(""),void n.slideUp()):(!l.reporter||!l.commodity||l.partner&&0!==+l.partner||(s.commodity=l.commodity,u.commodity=l.commodity,m=o.lookup(l.reporter,"reporterAreas","text")+" - Top-10 import markets for "+o.commodityName(l.commodity)+" in "+l.year),void t.query(s,function(t,a){if(t&&r.showError(t),!t&&a){var l=o.getData(u,d);i.html(m),n.find(".downloadData").on("click",function(t){t.preventDefault(),r.downloadCsv(m,l)}),n.slideDown(400,function(){e.draw(c,l,u,p.colors[0][0])})}}))}};return p}),define("helpers/charts",["./charts/choropleth","./charts/yearChart","./charts/infoBox","./charts/topExportCommodities","./charts/topExportMarkets","./charts/topImportCommodities","./charts/topImportMarkets"],function(t,e,r,o,n,a,i){"use strict";var l={balanceColors:["rgb(8,104,172)","rgb(120,198,121)"],importColors:["rgb(240,249,232)","rgb(186,228,188)","rgb(123,204,196)","rgb(67,162,202)","rgb(8,104,172)"],exportColors:["rgb(255,255,204)","rgb(194,230,153)","rgb(120,198,121)","rgb(49,163,84)","rgb(0,104,55)"],setup:function(s){l.colors=[l.balanceColors,l.importColors,l.exportColors],t.colors=l.colors,e.colors=l.colors,o.colors=l.colors,n.colors=l.colors,a.colors=l.colors,i.colors=l.colors,e.setup(),r.setup(),o.setup(),n.setup(),a.setup(),i.setup(),t.setup(function(){var t=l._getCssForSVGs();l._injectCSSintoSVG(t,d3.selectAll("svg")),s()})},_getCssForSVGs:function(){for(var t="",e=0;e<document.styleSheets.length;e++)if(document.styleSheets[e].href&&document.styleSheets[e].href.indexOf("main.svg.css")>=0)for(var r=0;r<document.styleSheets[e].cssRules.length;r++)t+=document.styleSheets[e].cssRules[r].cssText+" ";return t},_injectCSSintoSVG:function(t,e){e.insert("defs",":first-child").append("style").attr("type","text/css").text(t)}};return l}),define("helpers/embed",["require"],function(t){"use strict";var e={balanceColors:["rgb(8,104,172)","rgb(120,198,121)"],importColors:["rgb(240,249,232)","rgb(186,228,188)","rgb(123,204,196)","rgb(67,162,202)","rgb(8,104,172)"],exportColors:["rgb(255,255,204)","rgb(194,230,153)","rgb(120,198,121)","rgb(49,163,84)","rgb(0,104,55)"],setup:function(r){DEBUG&&console.log("This is an embed of "+r.embed),$("body").addClass("embed").addClass(r.embed+"Embedded"),$("#embedCredit").show(),$("#embedCredit a").attr("href",window.location.href.split("&embed")[0]),t(["./charts/"+r.embed],function(t){t.colors=[e.balanceColors,e.importColors,e.exportColors],t.setup(),t.refresh(null,r)})},hide:function(t){t.forEach(function(t){$("#"+t).hide()}),$("#loadingDiv").hide()}};return e}),require.config({urlArgs:"build="+(new Date).getTime()}),require(["helpers/data","helpers/gui","helpers/controls","helpers/charts","helpers/embed"],function(t,e,r,o,n){"use strict";"undefined"==typeof DEBUG&&(window.DEBUG=0),$(document).ready(function(){return Modernizr.svg?("comtrade.un.org"===location.host||Modernizr.cors||($("#userAlert").removeClass("hidden"),$("#userAlert .message").html('<strong>Warning</strong>: This application may not work correctly. Your browser does not support querying APIs which is necessary for this application to work. (Missing <a href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing">CORS</a>).<br /> Please try using a recent version of Firefox or Chrome.'),$("#loadingDiv").hide()),void t.setup(function(t){if(t)return DEBUG&&console.log(t),$("#userAlert").removeClass("hidden"),void $("#userAlert .message").html("Error: Failed to load required files for startup.");var a=r.decodeURL(),i=["choropleth","yearChart","topImportCommodities","topExportCommodities","topImportMarkets","topExportMarkets"];return a.embed&&i.indexOf(a.embed)>-1?(i.splice(i.indexOf(a.embed),1),n.hide(i),void n.setup(a)):(e.setup(),r.setup(),void o.setup(function(){r.initializeFilters()}))})):($("#userAlert").removeClass("hidden"),$("#userAlert .message").html("Error: it looks like your browser does not support SVG which is required for this visualization. Please consider updating to a more recent browser."),void $("#loadingDiv").hide())})}),define("main",function(){}),require(["main"]);
