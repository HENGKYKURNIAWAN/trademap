/**
 * @license almond 0.3.1 Copyright (c) 2011-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

var requirejs,require,define;!function(t){function e(t,e){return g.call(t,e)}function r(t,e){var r,o,n,a,i,l,s,c,d,u,p,m=e&&e.split("/"),f=h.map,y=f&&f["*"]||{};if(t&&"."===t.charAt(0))if(e){for(t=t.split("/"),i=t.length-1,h.nodeIdCompat&&x.test(t[i])&&(t[i]=t[i].replace(x,"")),t=m.slice(0,m.length-1).concat(t),d=0;d<t.length;d+=1)if(p=t[d],"."===p)t.splice(d,1),d-=1;else if(".."===p){if(1===d&&(".."===t[2]||".."===t[0]))break;d>0&&(t.splice(d-1,2),d-=2)}t=t.join("/")}else 0===t.indexOf("./")&&(t=t.substring(2));if((m||y)&&f){for(r=t.split("/"),d=r.length;d>0;d-=1){if(o=r.slice(0,d).join("/"),m)for(u=m.length;u>0;u-=1)if(n=f[m.slice(0,u).join("/")],n&&(n=n[o])){a=n,l=d;break}if(a)break;!s&&y&&y[o]&&(s=y[o],c=d)}!a&&s&&(a=s,l=c),a&&(r.splice(0,l,a),t=r.join("/"))}return t}function o(e,r){return function(){var o=v.call(arguments,0);return"string"!=typeof o[0]&&1===o.length&&o.push(null),d.apply(t,o.concat([e,r]))}}function n(t){return function(e){return r(e,t)}}function a(t){return function(e){m[t]=e}}function i(r){if(e(f,r)){var o=f[r];delete f[r],y[r]=!0,c.apply(t,o)}if(!e(m,r)&&!e(y,r))throw new Error("No "+r);return m[r]}function l(t){var e,r=t?t.indexOf("!"):-1;return r>-1&&(e=t.substring(0,r),t=t.substring(r+1,t.length)),[e,t]}function s(t){return function(){return h&&h.config&&h.config[t]||{}}}var c,d,u,p,m={},f={},h={},y={},g=Object.prototype.hasOwnProperty,v=[].slice,x=/\.js$/;u=function(t,e){var o,a=l(t),s=a[0];return t=a[1],s&&(s=r(s,e),o=i(s)),s?t=o&&o.normalize?o.normalize(t,n(e)):r(t,e):(t=r(t,e),a=l(t),s=a[0],t=a[1],s&&(o=i(s))),{f:s?s+"!"+t:t,n:t,pr:s,p:o}},p={require:function(t){return o(t)},exports:function(t){var e=m[t];return"undefined"!=typeof e?e:m[t]={}},module:function(t){return{id:t,uri:"",exports:m[t],config:s(t)}}},c=function(r,n,l,s){var c,d,h,g,v,x,w=[],$=typeof l;if(s=s||r,"undefined"===$||"function"===$){for(n=!n.length&&l.length?["require","exports","module"]:n,v=0;v<n.length;v+=1)if(g=u(n[v],s),d=g.f,"require"===d)w[v]=p.require(r);else if("exports"===d)w[v]=p.exports(r),x=!0;else if("module"===d)c=w[v]=p.module(r);else if(e(m,d)||e(f,d)||e(y,d))w[v]=i(d);else{if(!g.p)throw new Error(r+" missing "+d);g.p.load(g.n,o(s,!0),a(d),{}),w[v]=m[d]}h=l?l.apply(m[r],w):void 0,r&&(c&&c.exports!==t&&c.exports!==m[r]?m[r]=c.exports:h===t&&x||(m[r]=h))}else r&&(m[r]=l)},requirejs=require=d=function(e,r,o,n,a){if("string"==typeof e)return p[e]?p[e](r):i(u(e,r).f);if(!e.splice){if(h=e,h.deps&&d(h.deps,h.callback),!r)return;r.splice?(e=r,r=o,o=null):e=t}return r=r||function(){},"function"==typeof o&&(o=n,n=a),n?c(t,e,r,o):setTimeout(function(){c(t,e,r,o)},4),d},d.config=function(t){return d(t)},requirejs._defined=m,define=function(t,r,o){if("string"!=typeof t)throw new Error("See almond README: incorrect module build, no module name");r.splice||(o=r,r=[]),e(m,t)||e(f,t)||(f[t]=[t,r,o])},define.amd={jQuery:!0}}(),define("../node_modules/almond/almond",function(){}),define("helpers/data",["require"],function(){"use strict";var t=function(){var t={baseQueryUrl:"http://comtrade.un.org/api/get?fmt=csv&max=50000&type=C&freq=A&px=HS&rg=1%2C2",queryHistory:[],queryQueue:[],timestamp:0,reporterAreasSelect:[],partnerAreasSelect:[],commodityCodesSelect:[],reporterAreas:{},partnerAreas:{},flowByCode:{},commodityCodes:{},countryByUnNum:{},countryByISONum:{},xFilter:{},xFilterByReporter:{},xFilterByPartner:{},xFilterByYear:{},xFilterByCommodity:{},xFilterByFlow:{},xFilterByAmount:{},commodityName:function(t){var e=this.commodityCodes.get(t).text;return e.slice(e.indexOf(" - ")+3)},numFormat:function(t){var e=d3.format("$,");return t>=1e9?e(Math.round(t/1e9))+" bn":t>=1e6?e(Math.round(t/1e6))+" m":e(t)},numFormatFull:function(t){var e=d3.format("$,");return e(t)},numOrdinal:function(t){if(isNaN(t)||t%1)return t;if(20>t&&t>10)return t+"th";var e=t.toString().slice(-1),r="";switch(e){case"1":r=t+"st";break;case"2":r=t+"nd";break;case"3":r=t+"rd";break;default:r=t+"th"}return r},setup:function(e){$.when($.ajax("data/reporterAreas.min.json"),$.ajax("data/partnerAreas.min.json"),$.ajax("data/classificationHS_AG2.min.json"),$.ajax("data/isoCodes.csv"),$.ajax("data/world-50m.json")).then(function(r,o,n,a,i){t.reporterAreasSelect=r[0].results,t.partnerAreasSelect=o[0].results,t.commodityCodesSelect=n[0].results,t.worldJson=i[0];var l=d3.csv.parse(a[0]);t.countryByUnNum=d3.map(l,function(t){return t.unCode}),t.countryByISONum=d3.map(l,function(t){return t.isoNumerical}),t.reporterAreas=d3.map(r[0].results,function(t){return t.id}),t.flowByCode=d3.map([{id:"1",text:"imports"},{id:"2",text:"exports"},{id:"0",text:"balance"}],function(t){return t.id}),t.partnerAreas=d3.map(o[0].results,function(t){return t.id}),t.commodityCodes=d3.map(n[0].results,function(t){return t.id}),e()},function(){e("There was an error with one of the initial requests.")}),this.xFilter=crossfilter(),this.xFilterByReporter=this.xFilter.dimension(function(t){return+t.reporter}),this.xFilterByPartner=this.xFilter.dimension(function(t){return+t.partner}),this.xFilterByYear=this.xFilter.dimension(function(t){return+t.year}),this.xFilterByCommodity=this.xFilter.dimension(function(t){return t.commodity}),this.xFilterByFlow=this.xFilter.dimension(function(t){return+t.flow}),this.xFilterByAmount=this.xFilter.dimension(function(t){return+t.value}),t.query({commodity:"AG2",partner:0,reporter:826,year:2013,flow:1},function(){}),t.query({commodity:"TOTAL",partner:"all",reporter:826,year:2013,flow:2},function(){}),t.query({commodity:"TOTAL",partner:0,reporter:826,year:"all"},function(){})},query:function(e,r){var o=this._buildUrl(e),n=new Date;if(t.queryHistory.indexOf(o)>-1)return void r(null,!0);var a=n.getTime()-t.timestamp;return 1e3>a||t.queryQueue.indexOf(o)>-1?(window.setTimeout(function(){t.query(e,r)},a+100),void r(null,!1)):void $.ajax({url:o,crossDomain:!0,context:this,beforeSend:function(){this.timestamp=n.getTime(),this.queryQueue.push(o)},success:function(t){this.queryHistory.push(o);var n=this.queryQueue.indexOf(o);n>-1&&this.queryQueue.splice(n,1),this._addData(t,e),r(null,!0)},error:function(t,e,o){r(o,null)}})},getData:function(t,e){this.xFilterByReporter.filterAll(),this.xFilterByPartner.filterAll(),this.xFilterByYear.filterAll(),this.xFilterByCommodity.filterAll(),this.xFilterByFlow.filterAll(),this.xFilterByAmount.filterAll(),"undefined"!=typeof t.reporter&&this.xFilterByReporter.filter(+t.reporter),"undefined"!=typeof t.partner&&"all"===t.partner?this.xFilterByPartner.filter(function(t){return 0!==+t}):"undefined"!=typeof t.partner&&this.xFilterByPartner.filter(+t.partner),"undefined"!=typeof t.year&&"all"!==t.year&&this.xFilterByYear.filter(+t.year),"undefined"!=typeof t.commodity&&"AG2"!==t.commodity&&this.xFilterByCommodity.filter(t.commodity),"undefined"!=typeof t.commodity&&"AG2"===t.commodity&&this.xFilterByCommodity.filter(function(t){return"TOTAL"!==t}),"undefined"==typeof t.commodity&&this.xFilterByCommodity.filter(function(t){return"TOTAL"===t}),"undefined"!=typeof t.flow&&0!==+t.flow&&this.xFilterByFlow.filter(t.flow),e||(e=1/0);var r=this.xFilterByAmount.top(e);return r},combineData:function(t){var e=[],r=d3.map(),o=[],n=0,a=0;return t=t.filter(function(t){return 0!==+t.partner?!0:(1===t.flow&&(n=t.value),2===t.flow&&(a=t.value),!1)}),t.forEach(function(t){1===+t.flow&&r.set(t.partner,t),2===+t.flow&&o.push(t)}),o.forEach(function(t){var o=r.get(t.partner);if(o){var i={};i.reporter=t.reporter,i.partner=t.partner,i.commodity=t.commodity,i.year=t.year,i.importVal=o.value,i.exportVal=t.value,i.bilateralVal=o.value+t.value,i.balanceVal=t.value-o.value,0!==n&&0!==a&&(i.importPc=i.importVal/n*100,i.exportPc=i.exportVal/a*100),e.push(i)}}),e.sort(function(t,e){return+(e.importVal>t.importVal)||+(e.importVal===t.importVal)-1}),e.forEach(function(t,r){e[r].importRank=r+1}),e.sort(function(t,e){return+(e.exportVal>t.exportVal)||+(e.exportVal===t.exportVal)-1}),e.forEach(function(t,r){e[r].exportRank=r+1}),e},_buildUrl:function(e){var r=t.baseQueryUrl;return r+="undefined"!=typeof e.reporter?"&r="+e.reporter:"&r=0",r+="undefined"!=typeof e.partner?"&p="+e.partner:"&p=all",r+="undefined"!=typeof e.year&&null!==e.year?"&ps="+e.year:"&ps=now",r+="undefined"!=typeof e.commodity?"&cc="+e.commodity:"&cc=AG2"},_addData:function(t,e){var r=d3.csv.parse(t,function(t){return{reporter:+t["Reporter Code"],partner:+t["Partner Code"],year:+t.Year,commodity:t["Commodity Code"],flow:+t["Trade Flow Code"],value:+t["Trade Value (US$)"]}}),o=this.getData(e),n=r.filter(function(t){var e=!1;return o.forEach(function(r){t.reporter===r.reporter&&t.partner===r.partner&&t.commodity===r.commodity&&t.flow===r.flow&&t.year===r.year&&t.value===r.value&&(e=!0)}),!e});this.xFilter.add(n),DEBUG&&(console.groupCollapsed("Added %d new records. Retrieved %d records. Discarded %d duplicates. New xFilter size: %d",n.length,r.length,r.length-n.length,this.xFilter.size()),console.log("filters: %o",e),console.groupEnd())}};return t};return t()}),define("helpers/controls",["./data"],function(t){"use strict";var e={$selectReporter:$("#selectReporter"),$selectPartner:$("#selectPartner"),$selectCommodity:$("#selectCommodity"),$selectYear:$("#selectYear"),$flowButtons:$("#flowButtons"),$clearFilters:$("#clearFilters"),setup:function(){var r=$("#loadingDiv").hide();$(document).ajaxStart(function(){r.show()}).ajaxStop(function(){r.hide()}),this.$selectReporter.select2({placeholder:"Select a reporter",allowClear:!0,data:t.reporterAreasSelect}).on("change",e.onFilterChange),this.$selectPartner.select2({placeholder:"Select a partner",allowClear:!0,disabled:!0,data:t.partnerAreasSelect}).on("change",e.onFilterChange).select2("disable"),this.$selectCommodity.select2({placeholder:"Select a commodity",allowClear:!0,data:t.commodityCodesSelect}).on("change",e.onFilterChange).select2("disable"),this.$selectYear.select2({allowClear:!1,minimumResultsForSearch:1/0,disabled:!0}).on("change",e.onFilterChange),this.$flowButtons.on("click",function(t){$("#flowButtons button").removeClass("btn-primary").addClass("btn-default"),$(t.target).closest("button").removeClass("btn-default").addClass("btn-primary"),e.onFilterChange()}),this.$clearFilters.on("click",function(){$("#selectReporter, #selectPartner, #selectCommodity").off("change",e.onFilterChange).val(null).trigger("change").on("change",e.onFilterChange),e.onFilterChange()}),$("#goToCharts a, #goToMap a").tooltip(),$("#goToCharts a, #goToMap a").on("click",function(t){t.preventDefault();var e=this.hash;$("html, body").animate({scrollTop:$(e).offset().top},1e3,function(){})}),$("#closeContextMenu").on("click",function(t){t.preventDefault(),$("#contextMenu").hide()}),$("#contextMenu .setReporter").on("click",function(t){t.preventDefault(),$(t.target.parentNode).hasClass("disabled")||e.changeFilters({reporter:$(t.target).attr("data-uncode")}),$("#contextMenu").hide()}),$("#contextMenu .setPartner").on("click",function(t){t.preventDefault(),$(t.target.parentNode).hasClass("disabled")||e.changeFilters({partner:$(t.target).attr("data-uncode")}),$("#contextMenu").hide()})},onFilterChange:function(){var t={};""!==e.$selectReporter.val()&&(t.reporter=e.$selectReporter.val()),""!==e.$selectPartner.val()&&(t.partner=e.$selectPartner.val()),""!==e.$selectCommodity.val()&&(t.commodity=e.$selectCommodity.val()),""!==$("#flowButtons .btn-primary").attr("data-value")&&(t.flow=$("#flowButtons .btn-primary").attr("data-value")),""!==e.$selectYear.val()&&(t.year=e.$selectYear.val()),DEBUG&&console.log("New filters selected: %o",t),e.fadeControls(t),e.showElements(t),$(".chart").trigger("refreshFilters",t),e.updateURL(t)},changeFilters:function(t){(t.reporter||""!==e.$selectReporter.val())&&(t.reporter&&t.reporter!==e.$selectReporter.val()&&e.$selectReporter.val(t.reporter).trigger("change"),t.commodity&&t.commodity!==e.$selectCommodity.val()&&e.$selectCommodity.val(t.commodity).trigger("change"),t.partner&&t.partner!==e.$selectPartner.val()&&e.$selectPartner.val(t.partner).trigger("change"),t.year&&t.year!==e.$selectYear.val()&&e.$selectYear.val(t.year).trigger("change"))},initializeFilters:function(){var t=this.decodeURL();t&&t.reporter?this.changeFilters(t):e.changeFilters({reporter:826})},decodeURL:function(){return queryObject.get(["reporter","partner","flow","commodity","year"])},updateURL:function(t){queryObject.useHistory=!0,queryObject.set(t)},updateYears:function(t){if(t.length>0){var r=+e.$selectYear.val();e.$selectYear.html(""),t.sort(function(t,e){return e-t}).forEach(function(t){e.$selectYear.append('<option value="'+t+'">'+t+"</option>")}),t.indexOf(r)>=0?e.$selectYear.val(+r):e.$selectYear.val(d3.max(t)).trigger("change")}},fadeControls:function(t){t.reporter?($("#selectCommodity").select2("enable"),$("#selectPartner").select2("enable"),$("#selectYear").select2("enable")):($("#selectReporter, #selectPartner, #selectCommodity").off("change",e.onFilterChange).val(null).trigger("change").on("change",e.onFilterChange),$("#selectCommodity").select2("disable"),$("#selectPartner").select2("disable"),$("#selectYear").select2("disable"))},showElements:function(t){t.reporter?($("#goToCharts, #goToMap, #flowButtons").show(),$("#charts").slideDown(),$("#contextMenu .setPartner").removeClass("disabled")):($("#goToCharts, #goToMap, #flowButtons").hide(),$("#charts").slideUp(),$("#contextMenu .setPartner").addClass("disabled"))}};return e}),define("helpers/charts/choropleth",["../data","../controls"],function(t){"use strict";var e=t,r=$("#choropleth"),o=1080,n=1920,a=d3.select("#choropleth").append("svg").classed("choropleth",!0).attr("viewBox","0 0 "+n+" "+o).attr("preserveAspectRatio","xMidYMid meet"),i=["rgb(222, 98, 98)","rgb(116,196,118)"],l=["rgb(254,237,222)","rgb(253,190,133)","rgb(253,141,60)","rgb(230,85,13)","rgb(166,54,3)"],s=["rgb(237,248,233)","rgb(186,228,179)","rgb(116,196,118)","rgb(49,163,84)","rgb(0,109,44)"],c=[i,l,s],d={setup:function(i){r.on("refreshFilters",this.refresh);var l=d3.geo.kavrayskiy7().scale(330).translate([n/2+50,o/2]).precision(.1),s=d3.geo.path().projection(l),c=function(){a.attr("width",r.width()).attr("height",r.height())};c(),d3.select(window).on("resize",c),a.append("defs").append("path").datum({type:"Sphere"}).attr("id","sphere").attr("d",s).attr("stroke","#054D82").attr("stroke-width","1.5px").attr("fill","none"),a.append("use").attr("class","stroke").attr("xlink:href","#sphere"),a.append("use").attr("class","fill").attr("xlink:href","#sphere");var u=topojson.feature(t.worldJson,t.worldJson.objects.countries).features;a.append("g").attr("class","countries").selectAll(".country").data(u).enter().append("path").attr("class","country").attr("d",s).attr("id",function(t){return"iso"+t.id}).on("mouseover",function(t){d._clearInfo();try{d._displayInfo({partner:e.countryByISONum.get(t.id).unCode})}catch(r){console.log("No country in database by "+t.id+" isoCode.")}a.selectAll(".country").sort(function(e,r){return(e.id===t.id)-(r.id===t.id)})}).on("mouseout",function(){d._displayInfo({})}).on("click",function(t){d3.event.preventDefault(),$("#contextMenu .country").html(e.countryByISONum.get(t.id).name),$("#contextMenu .setReporter a, #contextMenu .setPartner a").attr("data-uncode",e.countryByISONum.get(t.id).unCode),$("#contextMenu").css({display:"block",left:d3.event.pageX,top:d3.event.pageY})}),i()},refresh:function(r,o){var n={};return o.reporter?o.reporter&&!o.commodity?(n={reporter:+o.reporter,partner:"all",commodity:"TOTAL",year:+o.year,flow:o.flow},void t.query(n,function(t,r){t&&console.log(t),!t&&r&&(d._redrawMap(n),$("#choroplethTitle div.chartTitle").html("Value of "+e.flowByCode.get(o.flow).text.toLowerCase()+" between "+e.countryByUnNum.get(o.reporter).name+" and the World in  "+o.year+"."))})):o.reporter&&o.commodity?(n={reporter:+o.reporter,partner:"all",commodity:o.commodity,year:+o.year,flow:o.flow},void t.query(n,function(t,r){t&&console.log(t),!t&&r&&(d._redrawMap(n),$("#choroplethTitle div.chartTitle").html("Value of "+e.flowByCode.get(o.flow).text.toLowerCase()+" between "+e.countryByUnNum.get(o.reporter).name+" and the World for "+e.commodityName(o.commodity)+" in "+o.year+"."))})):void 0:(a.selectAll(".country").style("fill","#fff"),void $("#choroplethTitle div.chartTitle").html(""))},_redrawMap:function(t){var r=e.getData({reporter:t.reporter,commodity:t.commodity,year:t.year});r=e.combineData(r);var o=d3.map(r,function(t){return t.partner}),n="";n=1===+t.flow?"importVal":2===+t.flow?"exportVal":"balanceVal";var i;i=0===+t.flow?d3.scale.threshold().domain([0]).range([0,1]):d3.scale.quantize().domain(d3.extent(r,function(t){return+t[n]})).range(d3.range(c[+t.flow].length)),a.selectAll(".country").classed("highlighted",!1).on("mouseover",function(t){d._clearInfo();try{var r=e.countryByISONum.get(t.id).unCode,n=o.get(r);n&&d._displayInfo(n),a.selectAll(".country").sort(function(e,r){return(e.id===t.id)-(r.id===t.id)})}catch(i){}}).transition().duration(1e3).style("fill",function(r){try{var a=e.countryByISONum.get(r.id).unCode,l=o.get(a),s=i(l[n]);return c[t.flow][s]}catch(d){return"#818181"}}),d._drawLegend(i,t.flow),$("#choroplethInfo .value").html(""),a.select("#iso"+e.countryByUnNum.get(t.reporter).isoNumerical).classed("highlighted",!0)},_drawLegend:function(t,r){var o=($("#mapLegend"),d3.select("#mapLegend svg")),n=c[r],a=["Balance","Imports","Exports"][r];o.select("g.legend").remove();var i=o.append("g").attr("class","legend").attr("transform","translate(0,20)");i.append("text").attr("class","title").attr("x",0).attr("y",0).style("font-weight","bold").text(a+" Legend"),i.append("rect").attr("class","noData").attr("x",0).attr("y",12).attr("rx",3).attr("ry",3).attr("width",18).attr("height",18).style("fill","#818181"),i.append("text").attr("class","noData").attr("x",22).attr("y",25).text("No data available"),i=i.append("g").attr("class","scale").attr("transform","translate(0,33)"),i.selectAll("rect").data(d3.range(n.length)).enter().append("rect").attr("x",0).attr("y",function(t,e){return 20*e}).attr("rx",3).attr("ry",3).attr("width",18).attr("height",18).style("fill",function(t,e){return n[e]}),i.selectAll("text").data(d3.range(n.length)).enter().append("text").attr("x",22).attr("y",function(t,e){return 20*e+15}).text(function(o,n){if(0===+r)return["Negative","Positive"][n];var a=t.invertExtent(n);return e.numFormat(a[0])+" - "+e.numFormat(a[1])})},_displayInfo:function(t){var r=$("#choroplethInfo"),o="",n="",a="";t.partner&&(o=e.countryByUnNum.get(t.partner).name,r.children(".countryName").html(o)),t.partner&&t.reporter&&(n=e.countryByUnNum.get(t.reporter).name,r.children(".countryName").html(n+" - "+o),t.commodity&&r.children(".commodity").html(e.commodityName(t.commodity)),t.importVal&&(a='<dl class="dl-horizontal"><dt>Imports from '+o+":</dt><dd>"+e.numFormat(t.importVal),t.importPc&&(a=a+" ("+t.importPc.toPrecision(2)+"% of "+n+" imports)"),a+="</dd></dl>",r.children(".imports").html(a)),t.exportVal&&(a='<dl class="dl-horizontal"><dt>Exports to '+o+":</dt><dd>"+e.numFormat(t.exportVal),t.exportPc&&(a=a+" ("+t.exportPc.toPrecision(2)+"% of "+n+" exports)"),a+="</dd></dl>",r.children(".exports").html(a)),t.balanceVal&&r.children(".balance").html('<dl class="dl-horizontal"><dt>Trade balance:</dt><dd>'+e.numFormat(t.balanceVal)+"</dd></dl>"),t.bilateralVal&&r.children(".bilateralTrade").html('<dl class="dl-horizontal"><dt>Bilateral trade:</dt><dd>'+e.numFormat(t.bilateralVal)+"</dd></dl>"),t.importRank&&t.exportRank&&(a=o+" is the "+e.numOrdinal(t.exportRank)+" export destination and the "+e.numOrdinal(t.importRank)+" import source for "+n,"TOTAL"!==t.commodity&&(a=a+" in "+e.commodityName(t.commodity)),r.children(".ranking").html(a))),t.reporter||t.partner||r.children(".value").html("")},_clearInfo:function(){$("#choroplethInfo .value").html("")}};return d}),define("helpers/charts/yearChart",["../data","../controls"],function(t,e){"use strict";var r=t,o=$("#yearChart"),n=d3.select("#yearChart").append("svg"),a={top:25,right:15,bottom:30,left:70},i=o.height(),l=o.width(),s=i-a.top-a.bottom,c=l-a.left-a.right,d=d3.scale.linear().range([0,c]).clamp(!0),u=d3.scale.linear().range([s,0]),p=d3.svg.axis().scale(d).orient("bottom").tickFormat(d3.format(".0f")),m=d3.svg.axis().scale(u).orient("left").ticks(6).tickFormat(r.numFormat),f=d3.svg.line().interpolate("linear"),h=["rgb(166,54,3)","rgb(0,109,44)"],y={setup:function(){o.on("refreshFilters",this.refresh),n.attr("width",l).attr("height",i),n.append("g").attr("class","x axis").attr("transform","translate("+a.left+","+(a.top+s)+")").call(p),n.append("g").attr("class","y axis").attr("transform","translate("+a.left+","+a.top+")").call(m),n.append("g").attr("class","plots").attr("transform","translate("+a.left+","+a.top+")");var t=n.append("g").attr("class","legend").attr("transform","translate("+a.left+",0)").selectAll(".legendItem").data(h).enter().append("g").attr("class","legendItem");t.append("circle").attr("cx",function(t,e){return c-120*(e+1)}).attr("cy","10").attr("r","5").style("fill",function(t){return t}),t.append("text").attr("transform",function(t,e){return"translate("+(c+10-120*(e+1))+",15)"}).text(function(t,e){return["Imports","Exports"][e]}),o.slideUp(0)},refresh:function(e,n){if(!n.reporter)return void o.slideUp();var a={reporter:+n.reporter,year:"all"},i=a,l="";!n.reporter||n.commodity||n.partner||(l="Total imports and Exports of "+r.countryByUnNum.get(n.reporter).name,a.partner=0,a.commodity="TOTAL",i=a),n.reporter&&!n.commodity&&n.partner&&(l="Imports and Exports between "+r.countryByUnNum.get(n.reporter).name+" and "+r.countryByUnNum.get(n.partner).name,a.partner=+n.partner,a.commodity="AG2",i.partner=+n.partner,i.commodity="TOTAL"),n.reporter&&n.commodity&&!n.partner&&(l="Imports and Exports of "+r.commodityName(n.commodity)+" to/from "+r.countryByUnNum.get(n.reporter).name,a.partner=0,a.commodity=n.commodity,i=a),n.reporter&&n.commodity&&n.partner&&(l="Imports and Exports of "+r.commodityName(n.commodity)+" between "+r.countryByUnNum.get(n.reporter).name+" and "+r.countryByUnNum.get(n.partner).name,a.partner=+n.partner,a.commodity="AG2",i.partner=+n.partner,i.commodity=n.commodity),t.query(a,function(t,e){if(t&&console.log(t),!t&&e){var n=r.getData(i);$(".yearChart.chartTitle").html(l),o.slideDown(400,function(){y._draw(n)})}})},_draw:function(t){var o=d3.nest().key(function(t){return t.flow}).sortValues(function(t,e){return t.year-e.year}).entries(t),i=d3.extent(t,function(t){return t.year}),l=d3.range(i[0],i[1]+1),c=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(t){return t.year+": "+r.numFormatFull(t.value)+" "+["imports","exports"][t.flow-1]});d.domain([i[0],i[1]+1]),u.domain([0,d3.max(t,function(t){return t.value})]),f.x(function(t){return d(t.year)}).y(function(t){return u(t.value)}),p.scale(d).tickValues(l).tickSize(6,0).tickFormat(d3.format(".0f")),m.scale(u).tickSize(6,0).tickFormat(r.numFormat),e.updateYears(l),n.select(".x.axis").transition().call(p),n.select(".y.axis").transition().call(m);var y=n.selectAll("line.highlight").data([1]),g=$("#selectYear").val();y.enter().append("line").attr("class","highlight").attr("x1","0").attr("y1",a.top).attr("x2","0").attr("y2",a.top+s).attr("stroke","#054D82").attr("stroke-dasharray","5, 5").attr("stroke-width","1"),y.transition().attr("x1",function(){return d(+g)+a.left}).attr("x2",function(){return d(+g)+a.left});var v=n.select(".plots"),x=v.selectAll("path.flow").data(o);x.enter().append("path").attr("class","flow").style("stroke",function(t){return h[t.key-1]}).style("fill","none").style("stroke-width","1.5px"),x.transition().attr("d",function(t){return f(t.values)});var w=v.selectAll("g.flow").data(o);w.enter().append("g").attr("class","flow");var b=w.selectAll("circle.dot").data(function(t){return t.values});b.enter().append("circle").attr("class","dot").attr("r","3").style("fill",function(t){return h[t.flow-1]}).style("stroke-width","0").on("mouseover",function(t){c.show(t),d3.select(this).interrupt().transition().attr("r","6")}).on("mouseout",function(t){c.hide(t),d3.select(this).interrupt().transition().attr("r","3")}).on("click",function(t){e.changeFilters({year:t.year})}),b.transition().attr("cx",function(t){return d(t.year)}).attr("cy",function(t){return u(t.value)}),b.exit().remove(),v.call(c)}};return y}),define("helpers/barchart",["./data","./controls"],function(t,e){"use strict";var r=t,o={top:25,right:15,bottom:30,left:70},n=0,a=0,i={setup:function(t){n=t.attr("height")-o.top-o.bottom,a=t.attr("width")-o.left-o.right;var e=d3.scale.linear().range([0,a]).clamp(!0),i=d3.scale.linear().range([n,0]),l=d3.svg.axis().scale(e).orient("bottom"),s=d3.svg.axis().scale(i).orient("left").ticks(6).tickFormat(r.numFormat);t.append("g").attr("class","x axis").attr("transform","translate("+o.left+","+(o.top+n)+")").call(l),t.append("g").attr("class","y axis").attr("transform","translate("+o.left+","+o.top+")").call(s),t.append("g").attr("class","yGrid").attr("transform","translate("+o.left+","+o.top+")"),t.append("g").attr("class","bars").attr("transform","translate("+o.left+","+o.top+")")},draw:function(t,o,i){var l=d3.scale.linear().range([0,a]).domain([0,o.length]).clamp(!0),s=d3.scale.linear().range([n,0]).domain([0,d3.max(o,function(t){return t.value})]),c=d3.svg.axis().scale(l).orient("bottom").tickValues(d3.range(0,o.length)).tickSize(0,0).tickFormat(""),d=d3.svg.axis().scale(s).orient("left").ticks(6).tickSize(6,0).tickFormat(r.numFormat),u=6,p=a/o.length-u,m=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(t){return"all"==i.partner?r.countryByUnNum.get(t.partner).name+" "+["imports","exports"][t.flow-1]+": "+r.numFormat(t.value)+" in "+t.year+".":r.commodityName(t.commodity)+" "+["imports","exports"][t.flow-1]+": "+r.numFormat(t.value)+" in "+t.year+": ."});t.select(".x.axis").transition().call(c),t.select(".y.axis").transition().call(d),t.select(".yGrid").html("").call(d.tickSize(-a,0,0).tickFormat(""));var f=t.select(".bars").selectAll("g.item").data(o);f.enter().append("g").append("rect").attr("width","0").attr("height","0"),f.attr("class",function(t,e){return"item rep"+t.reporter+" part"+t.partner+" comm"+t.commodity+" v"+t.value+" y"+t.year+" i"+e}).attr("transform",function(t,e){return"translate("+l(e)+",0)"}),f.selectAll("g.item text").remove();var h=f.select("rect").on("mouseenter",function(t){d3.select(this).interrupt().transition().style("opacity","0.6"),m.show(t)}).on("mouseout",function(t){d3.select(this).interrupt().transition().style("opacity","0.8"),m.hide(t)}).on("click",function(t){e.changeFilters("all"==i.partner?{partner:t.partner}:{commodity:t.commodity})}),y=f.append("text");h.transition().attr("class",function(t,e){return"item rep"+t.reporter+" part"+t.partner+" comm"+t.commodity+" v"+t.value+" y"+t.year+" i"+e}).attr("x",u).attr("y",function(t){return s(+t.value)}).attr("height",function(t){return n-s(+t.value)}).attr("width",function(){return p}),y.attr("x",function(){return u-n}).attr("y",function(){return u+u/2+p/2}).attr("class","label").attr("transform","rotate(-90)").text(function(t){return"all"==i.partner?r.countryByUnNum.get(t.partner).name:r.commodityName(t.commodity)}),f.exit().remove(),f.call(m)}};return i}),define("helpers/charts/topExportCommodities",["../data","../barchart"],function(t,e){"use strict";var r=t,o=$("#topExportCommodities"),n=o.height(),a=o.width(),i=d3.select("#topExportCommodities").append("svg").attr("height",n).attr("width",a),l=20,s={setup:function(){o.on("refreshFilters",this.refresh),e.setup(i),o.slideUp(0)},refresh:function(n,a){if(!a.reporter)return void o.slideUp();var s={reporter:+a.reporter,partner:0,year:a.year,commodity:"AG2"},c=s,d="";return c.flow=2,!a.reporter||a.commodity||a.partner||(d="Top commodities exported by "+r.reporterAreas.get(a.reporter).text+" in "+a.year),a.reporter&&!a.commodity&&a.partner&&(d="Top commodities exported in "+a.year+" by "+r.reporterAreas.get(a.reporter).text+" to "+r.partnerAreas.get(a.partner).text+".",c.partner=+a.partner),a.reporter&&a.commodity&&!a.partner?void o.slideUp():a.reporter&&a.commodity&&a.partner?void o.slideUp():void t.query(s,function(t,n){if(t&&console.log(t),!t&&n){var a=r.getData(c,l);o.children(".chartTitle").html(d),o.slideDown(400,function(){e.draw(i,a,c)})}})}};return s}),define("helpers/charts/topExportDestinations",["../data","../barchart"],function(t,e){"use strict";var r=t,o=$("#topExportDestinations"),n=o.height(),a=o.width(),i=d3.select("#topExportDestinations").append("svg").attr("height",n).attr("width",a),l=20,s={setup:function(){o.on("refreshFilters",this.refresh),e.setup(i),o.slideUp(0)},refresh:function(n,a){if(!a.reporter)return void o.slideUp();var s={reporter:+a.reporter,partner:"all",year:a.year,commodity:"AG2"},c=s,d="";return c.flow=2,!a.reporter||a.commodity||a.partner||(d="Top export destinations for "+r.reporterAreas.get(a.reporter).text+" in "+a.year,c.commodity="TOTAL"),a.reporter&&!a.commodity&&a.partner?void o.slideUp():(a.reporter&&a.commodity&&!a.partner&&(d="Top export destinations of "+r.commodityName(a.commodity)+" for "+r.reporterAreas.get(a.reporter).text+" in "+a.year,c.commodity=a.commodity),a.reporter&&a.commodity&&a.partner?void o.slideUp():void t.query(s,function(t,n){if(t&&console.log(t),!t&&n){var a=r.getData(c,l);o.children(".chartTitle").html(d),o.slideDown(400,function(){e.draw(i,a,c)})}}))}};return s}),define("helpers/charts/topImportCommodities",["../data","../barchart"],function(t,e){"use strict";var r=t,o=$("#topImportCommodities"),n=o.height(),a=o.width(),i=d3.select("#topImportCommodities").append("svg").attr("height",n).attr("width",a),l=20,s={setup:function(){o.on("refreshFilters",this.refresh),e.setup(i),o.slideUp(0)},refresh:function(n,a){if(!a.reporter)return void o.slideUp();var s={reporter:+a.reporter,partner:0,year:a.year,commodity:"AG2"},c=s,d="";return c.flow=1,!a.reporter||a.commodity||a.partner||(d="Top import commodities in "+a.year+" for "+r.reporterAreas.get(a.reporter).text+" from rest of the world."),a.reporter&&!a.commodity&&a.partner&&(d="Top import commodities in "+a.year+" for "+r.reporterAreas.get(a.reporter).text+" from "+r.partnerAreas.get(a.partner).text+".",c.partner=+a.partner),a.reporter&&a.commodity&&!a.partner?void o.slideUp():a.reporter&&a.commodity&&a.partner?void o.slideUp():void t.query(s,function(t,n){if(t&&console.log(t),!t&&n){var a=r.getData(c,l);o.children(".chartTitle").html(d),o.slideDown(400,function(){e.draw(i,a,c)})}})}};return s}),define("helpers/charts/topImportSources",["../data","../barchart"],function(t,e){"use strict";var r=t,o=$("#topImportSources"),n=o.height(),a=o.width(),i=d3.select("#topImportSources").append("svg").attr("height",n).attr("width",a),l=20,s={setup:function(){o.on("refreshFilters",this.refresh),e.setup(i),o.slideUp(0)},refresh:function(n,a){if(!a.reporter)return void o.slideUp();var s={reporter:+a.reporter,partner:"all",year:a.year,commodity:"AG2"},c=s,d="";return c.flow=1,!a.reporter||a.commodity||a.partner||(c.commodity="TOTAL",d="Top import sources for "+r.reporterAreas.get(a.reporter).text+" in "+a.year),a.reporter&&!a.commodity&&a.partner?void o.slideUp():(a.reporter&&a.commodity&&!a.partner&&(c.commodity=a.commodity,d="Top import sources of "+r.commodityName(a.commodity)+" for "+r.reporterAreas.get(a.reporter).text+" in "+a.year),a.reporter&&a.commodity&&a.partner?void o.slideUp():void t.query(c,function(t,n){if(t&&console.log(t),!t&&n){var a=r.getData(c,l);o.children(".chartTitle").html(d),o.slideDown(400,function(){e.draw(i,a,c)})}}))}};return s}),define("helpers/charts",["./charts/choropleth","./charts/yearChart","./charts/topExportCommodities","./charts/topExportDestinations","./charts/topImportCommodities","./charts/topImportSources"],function(t,e,r,o,n,a){"use strict";var i={setup:function(i){e.setup(),r.setup(),o.setup(),n.setup(),a.setup(),t.setup(i)}};return i}),require(["helpers/data","helpers/controls","helpers/charts"],function(t,e,r){"use strict";window.DEBUG=!0,$(document).ready(function(){Modernizr.svg?t.setup(function(t){return t?(DEBUG&&console.log(t),$("#userAlert").removeClass("hidden"),void $("#userAlert .message").html("Error: Failed to load required files for startup.")):(e.setup(),void r.setup(function(){e.initializeFilters()
}))}):($("#userAlert").removeClass("hidden"),$("#userAlert .message").html("Error: it looks like your browser does not support SVG which is required for this visualization. Please consider updating to a more recent browser."))})}),define("main",function(){}),require(["main"]);
